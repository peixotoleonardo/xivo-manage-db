#!/bin/bash
# This script merge the xivo database into the asterisk database and
# then drops the xivo database and the xivo user.
#
# It must be executed as user postgres.

set -e
export PGOPTIONS='--client-min-messages=warning'

psql="psql -v ON_ERROR_STOP="


# merge xivo database into asterisk database
pg_dump xivo | $psql asterisk


# set the owner of all tables and sequences to asterisk
$psql asterisk <<'EOF'
BEGIN;

DO $$
DECLARE
	table_name pg_catalog.name;
BEGIN
	FOR table_name IN SELECT tablename FROM pg_tables
	WHERE schemaname = 'public'
	LOOP
		EXECUTE 'ALTER TABLE "' || table_name || '" OWNER TO asterisk';
	END LOOP;
END $$;

DROP OWNED BY xivo;

COMMIT;

EOF


# drop database xivo and role xivo
$psql <<'EOF'
DROP DATABASE xivo;
DROP ROLE xivo;

EOF

#!/bin/sh

set -e

case "$1" in
    configure)
        new_dir=/var/lib/xivo-manage-db/update-db
        for old_dir in /var/lib/xivo-update-db /var/lib/xivo-upgrade/update-db ; do
            if [ -d "$old_dir" ]; then
                mv "$old_dir"/* "$new_dir"
                rm -fr "$old_dir"
            fi
        done

        # When installing from ISO, Postgres is not running
        if pg_lsclusters --no-header | grep -q online ; then
            if ! sudo -u postgres psql -tA asterisk --quiet -c "SELECT count(*) from userfeatures" > /dev/null 2>&1 ; then
                xivo-init-db --init
            fi

            previous_version="$2"
            if dpkg --compare-versions "$previous_version" lt "16.01~20160125"; then
                sudo -u postgres psql -c 'create extension if not exists pgcrypto;' asterisk > /dev/null 2>&1
            fi
            if dpkg --compare-versions "$previous_version" lt "17.02"; then
                sudo -u postgres psql -c 'create extension if not exists "uuid-ossp";' asterisk > /dev/null 2>&1
            fi

            xivo-update-db
            xivo-update-keys
            xivo-configure-uuid
        fi
    ;;

    abort-upgrade)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0

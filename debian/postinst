#!/bin/bash

set -e

case "$1" in
    configure)
        # In wazo 18.07 we completely remove the old migration system
        rm -f /var/lib/xivo-manage-db/update-db/asterisk-last
        rm -f /var/lib/xivo-manage-db/update-db/xivo-last

        # When installing from ISO, Postgres is not running
        if pg_lsclusters --no-header | grep -q online ; then
            if ! sudo -u postgres psql -tA asterisk --quiet -c "SELECT count(*) from userfeatures" > /dev/null 2>&1 ; then
                xivo-init-db --init
            fi

            previous_version="$2"
            if [[ -z "${previous_version}" ]]; then
                sudo -u postgres psql -c 'create extension if not exists pgcrypto;' asterisk > /dev/null 2>&1
            fi
            if [[ -z "${previous_version}" ]]; then
                sudo -u postgres psql -c 'create extension if not exists "uuid-ossp";' asterisk > /dev/null 2>&1
            fi

            xivo-update-db
            xivo-update-keys
        fi
    ;;

    abort-upgrade)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
